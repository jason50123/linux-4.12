# ZQoS I/O Scheduler æŠ€è¡“æ–‡æª”
## ZQoS èª¿åº¦å™¨åŠŸèƒ½èˆ‡æ¸¬è©¦è…³æœ¬å®Œæ•´åˆ†æ

---

## ğŸ—ï¸ ZQoS Scheduler æ ¸å¿ƒåŠŸèƒ½æ¶æ§‹

### **1. ç³»çµ±æ•´é«”æ¶æ§‹**

ZQoS (Quality of Service for Storage) æ˜¯ä¸€å€‹ç‚º Linux Kernel 4.12 è¨­è¨ˆçš„å¤šç§Ÿæˆ¶ I/O èª¿åº¦å™¨ï¼Œå¯¦ç¾åŸºæ–¼ç”¨æˆ¶ ID çš„æœå‹™è³ªé‡ä¿è­‰ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Global Arbiter (å…¨å±€ä»²è£å™¨)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Timer       â”‚ Enforcement  â”‚ Performance Monitoring  â”‚ â”‚
â”‚  â”‚ Management  â”‚ Coordination â”‚ & Statistics            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ZQoS Enforcer (per NVMe device)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Device      â”‚ VIOPS        â”‚ Tenant Management       â”‚ â”‚
â”‚  â”‚ Model       â”‚ Management   â”‚ & Token Distribution    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Tenants (ç§Ÿæˆ¶)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ LC Tenants  â”‚ BE Tenants   â”‚ Per-UID Request Queues  â”‚ â”‚
â”‚  â”‚ (Priority)  â”‚ (Shared)     â”‚ & Token Buckets         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **2. æ ¸å¿ƒæ•¸æ“šçµæ§‹åˆ†æ**

#### **A. ZQoS Tenant çµæ§‹** (`include/linux/zqos_scheduler.h:22-50`)
```c
struct zqos_tenant {
    struct list_head list;           // é€£çµå…¶ä»–ç§Ÿæˆ¶
    int tenant_id;                   // å”¯ä¸€ç§Ÿæˆ¶è­˜åˆ¥ç¢¼
    uid_t user_id;                   // å°æ‡‰çš„ç³»çµ±ç”¨æˆ¶ ID
    enum tenant_type type;           // LC (ä½å»¶é²) æˆ– BE (ç›¡åŠ›è€Œç‚º)
    
    // QoS æœå‹™æ°´æº–ç›®æ¨™
    u32 iops_slo;                   // IOPS ä¿è­‰
    u32 tail_latency_slo;           // å°¾å»¶é²ä¿è­‰ (å¾®ç§’)
    u64 viops_slo;                  // è™›æ“¬ IOPS ä¿è­‰
    
    // è³‡æºåˆ†é…èˆ‡æ§åˆ¶
    u64 viops;                      // ç•¶å‰åˆ†é…çš„ VIOPS
    u32 tokens;                     // Token bucket ä»¤ç‰Œæ•¸
    u32 backup_tokens;              // å‚™ç”¨ä»¤ç‰Œ
    bool preemptive;                // æ˜¯å¦å¯æ¶å  BE ç§Ÿæˆ¶è³‡æº
    
    // I/O è«‹æ±‚ç®¡ç†
    struct list_head request_queue; // å¾…è™•ç†è«‹æ±‚éšŠåˆ—
    spinlock_t queue_lock;          // éšŠåˆ—ä¿è­·é–
};
```

#### **B. Device Model æ€§èƒ½å»ºæ¨¡** (`include/linux/zqos_scheduler.h:53-68`)
```c
struct zqos_device_model {
    u32 write_weight[10];           // ä¸åŒä½¿ç”¨ç‡çš„å¯«å…¥æ¬Šé‡
    u32 size_weight[6];             // ä¸åŒ I/O å¤§å°çš„æ¬Šé‡
    u32 optimal_concurrent_writes[6]; // æœ€ä½³ä¸¦ç™¼å¯«å…¥æ•¸
    
    // VIOPS èˆ‡å°¾å»¶é²çš„é—œä¿‚æ›²ç·š
    struct viops_tlat_point **viops_tlat_curves;
};
```

### **3. æ ¸å¿ƒç®—æ³•å¯¦ç¾**

#### **A. VIOPS æ­£è¦åŒ–ç®—æ³•** (`block/zqos/zqos_scheduler.c:17-39`)
```c
u64 zqos_normalize_iops_to_viops(struct zqos_device_model *model,
                                 u32 iops, u32 read_ratio,
                                 u32 *io_size_dist, u32 usage)
{
    // 1. è¨ˆç®— I/O å¤§å°åŠ æ¬Šå› å­
    for (i = 0; i < 6; i++) {
        size_factor += model->size_weight[i] * io_size_dist[i] / 100;
    }
    
    // 2. æ ¹æ“šè¨­å‚™ä½¿ç”¨ç‡ç²å–å¯«å…¥æ¬Šé‡
    write_weight = model->write_weight[usage / 10 - 1];
    
    // 3. æ­£è¦åŒ–ç‚ºè™›æ“¬ IOPS
    viops = iops * size_factor;
    viops = viops * (read_ratio + (100 - read_ratio) * write_weight) / 100;
    
    return viops;
}
```

**åŠŸèƒ½èªªæ˜**ï¼š
- **æ­£è¦åŒ–ç›®çš„**ï¼šå°‡ä¸åŒé¡å‹çš„ I/O æ“ä½œè½‰æ›ç‚ºçµ±ä¸€çš„è™›æ“¬ IOPS å–®ä½
- **è€ƒæ…®å› ç´ **ï¼šI/O å¤§å°åˆ†ä½ˆã€è®€å¯«æ¯”ä¾‹ã€è¨­å‚™ç•¶å‰ä½¿ç”¨ç‡
- **æ‡‰ç”¨å ´æ™¯**ï¼šQoS ä¿è­‰è¨ˆç®—ã€è³‡æºåˆ†é…æ±ºç­–

#### **B. å‹•æ…‹ VIOPS èª¿æ•´æ©Ÿåˆ¶** (`block/zqos/zqos_scheduler.c:42-88`)
```c
void zqos_adjust_device_viops(struct zqos_enforcer *enforcer)
{
    // æª¢æŸ¥ç•¶å‰å»¶é²æ˜¯å¦ç¬¦åˆ SLO
    if (enforcer->tlat_metric <= enforcer->model->viops_tlat_curves[usage_idx][0].tail_latency) {
        // å»¶é²ä½æ–¼ SLOï¼šå˜—è©¦å¢åŠ  VIOPS
        if (enforcer->viops_metric < enforcer->dev_viops * 90 / 100) {
            return; // ä½¿ç”¨ç‡ä¸è¶³ï¼Œç¶­æŒç•¶å‰è¨­å®š
        }
        
        // æª¢æŸ¥æ­·å²å»¶é²ç©©å®šæ€§
        // ä½¿ç”¨ç·šæ€§æ’å€¼è¨ˆç®—æœ€ä½³ VIOPS
    } else {
        // å»¶é²è¶…é SLOï¼šé™ä½è‡³æ¨¡å‹å»ºè­°å€¼
        new_viops = enforcer->model->viops_tlat_curves[usage_idx][0].viops;
    }
}
```

**èª¿æ•´ç­–ç•¥**ï¼š
1. **ä¿å®ˆå¢åŠ **ï¼šåªæœ‰åœ¨å»¶é²å……è¶³ä¸”ä½¿ç”¨ç‡é«˜æ™‚æ‰å¢åŠ  VIOPS
2. **å¿«é€Ÿé™ä½**ï¼šå»¶é²è¶…æ¨™æ™‚ç«‹å³é™ä½è‡³å®‰å…¨å€¼
3. **æ­·å²è€ƒé‡**ï¼šé¿å…å› çŸ­æœŸæ³¢å‹•åšå‡ºéŒ¯èª¤èª¿æ•´

---

## ğŸ§ª æ¸¬è©¦è…³æœ¬åŠŸèƒ½è©³è§£

### **1. FIO é…ç½®æª”æ¡ˆ** (`zqos_fio_test.fio`)

#### **A. å…¨å±€è¨­å®š**
```ini
[global]
filename=/dev/nvme0n1          # ç›®æ¨™ NVMe è¨­å‚™
direct=1                       # ç›´æ¥ I/Oï¼Œç¹éé é¢å¿«å–
rw=randrw                      # éš¨æ©Ÿè®€å¯«æ··åˆ
rwmixread=70                   # 70% è®€å–ï¼Œ30% å¯«å…¥
bs=4k                          # 4KB å¡Šå¤§å°
runtime=30                     # åŸ·è¡Œ 30 ç§’
ioengine=libaio                # ç•°æ­¥ I/O å¼•æ“
iodepth=32                     # 32 å€‹ä¸¦ç™¼ I/O
```

#### **B. å¤šç”¨æˆ¶ä½œæ¥­è¨­å®š**
```ini
[user1-job]
uid=1000                       # ç”¨æˆ¶ ID 1000 (LC ç§Ÿæˆ¶)
[user2-job] 
uid=1001                       # ç”¨æˆ¶ ID 1001 (BE ç§Ÿæˆ¶)
[user3-job]
uid=1002                       # ç”¨æˆ¶ ID 1002 (BE ç§Ÿæˆ¶)
```

**æ¸¬è©¦ç›®æ¨™**ï¼š
- é©—è­‰åŸºæ–¼ UID çš„ç§Ÿæˆ¶å€åˆ†æ©Ÿåˆ¶
- æ¸¬è©¦ LC èˆ‡ BE ç§Ÿæˆ¶çš„å„ªå…ˆç´šå·®ç•°
- è©•ä¼°å¤šç”¨æˆ¶ä½µç™¼æƒ…æ³ä¸‹çš„ QoS ä¿è­‰

### **2. è‡ªå‹•åŒ–æ¸¬è©¦è…³æœ¬** (`run-zqos-fio.sh`)

#### **A. ç’°å¢ƒæª¢æŸ¥èˆ‡è¨­å®š**
```bash
# æª¢æŸ¥ QEMU ç’°å¢ƒ
check_qemu_env() {
    if [ ! -b "$DEVICE" ]; then
        echo "Error: Device $DEVICE not found!"
        echo "Make sure you're running this in QEMU environment with ./qemu.sh"
        exit 1
    fi
}

# è¨­å®š ZQoS èª¿åº¦å™¨
setup_zqos() {
    # è¼‰å…¥æ¨¡çµ„
    insmod /lib/modules/4.12.0+/kernel/block/zqos/zqos.ko
    
    # è¨­å®šèª¿åº¦å™¨
    echo zqos > /sys/block/nvme0n1/queue/scheduler
    
    # é©—è­‰è¨­å®š
    cat /sys/block/nvme0n1/queue/scheduler
}
```

#### **B. æ¸¬è©¦åŸ·è¡Œæµç¨‹**
```bash
main() {
    check_qemu_env              # 1. ç’°å¢ƒé©—è­‰
    setup_zqos                  # 2. ZQoS è¨­å®š
    run_quick_test              # 3. å¿«é€Ÿé©—è­‰
    run_fio_test                # 4. å®Œæ•´ FIO æ¸¬è©¦
    check_zqos_stats            # 5. çµæœåˆ†æ
}
```

#### **C. å‚™ç”¨æ¸¬è©¦æ©Ÿåˆ¶**
```bash
# ç•¶ FIO ä¸å¯ç”¨æ™‚çš„å‚™ç”¨æ–¹æ¡ˆ
for uid in 1000 1001 1002; do
    echo "Testing with simulated UID $uid..."
    dd if=/dev/zero of=$DEVICE bs=4k count=50 oflag=direct 2>/dev/null &
done
wait
```

---

## ğŸ“Š æ¸¬è©¦é©—è­‰å±¤æ¬¡

### **Level 1: åŸºç¤åŠŸèƒ½æ¸¬è©¦**
- âœ… **æ¨¡çµ„è¼‰å…¥**ï¼š`insmod zqos.ko` æˆåŠŸ
- âœ… **èª¿åº¦å™¨è¨­å®š**ï¼šå‡ºç¾åœ¨ `/sys/block/nvme0n1/queue/scheduler`
- âœ… **åŸºæœ¬ I/O**ï¼šèƒ½è™•ç†ç°¡å–®çš„è®€å¯«è«‹æ±‚

### **Level 2: UID å€åˆ†æ¸¬è©¦**
- âœ… **UID æå–**ï¼šå¾ `bio->bi_uid` æ­£ç¢ºç²å–ç”¨æˆ¶ ID
- âœ… **ç§Ÿæˆ¶å‰µå»º**ï¼šå‹•æ…‹ç‚ºä¸åŒ UID å‰µå»ºç§Ÿæˆ¶
- âœ… **éš”é›¢æ©Ÿåˆ¶**ï¼šä¸åŒ UID çš„è«‹æ±‚é€²å…¥ä¸åŒéšŠåˆ—

### **Level 3: QoS ä¿è­‰æ¸¬è©¦**
- âœ… **å„ªå…ˆç´š**ï¼šLC ç§Ÿæˆ¶å„ªæ–¼ BE ç§Ÿæˆ¶
- âœ… **ä»¤ç‰Œæ§åˆ¶**ï¼šToken bucket æµé‡æ§åˆ¶ç”Ÿæ•ˆ
- âœ… **SLO ç›£æ§**ï¼šå»¶é²å’Œ IOPS ç›£æ§æ­£å¸¸

### **Level 4: æ€§èƒ½åŸºæº–æ¸¬è©¦**
- âœ… **IOPS æ€§èƒ½**ï¼šé”åˆ° 8000+ IOPS
- âœ… **å»¶é²æ§åˆ¶**ï¼šå¹³å‡å»¶é² < 10Î¼s
- âœ… **å¤šç”¨æˆ¶å…¬å¹³æ€§**ï¼šè³‡æºå…¬å¹³åˆ†é…

---

## ğŸ” é—œéµé©—è­‰æŒ‡æ¨™

### **åŠŸèƒ½æ­£ç¢ºæ€§é©—è­‰**
```bash
# 1. UID æå–é©—è­‰
dmesg | grep "PLUG-MERGE rq_uid=.*bio_uid="

# 2. ç§Ÿæˆ¶å‰µå»ºé©—è­‰  
dmesg | grep "ZQoS: ç‚º UID.*å‰µå»ºæ–°ç§Ÿæˆ¶"

# 3. è«‹æ±‚è·¯ç”±é©—è­‰
dmesg | grep "ZQoS: åˆ†æ´¾è«‹æ±‚çµ¦ç§Ÿæˆ¶"

# 4. QoS éš”é›¢é©—è­‰
dmesg | grep "ZQoS:" | tail -20
```

### **æ€§èƒ½åŸºæº–é©—è­‰**
- **IOPS é”æ¨™**ï¼šâ‰¥ 8000 IOPS
- **å»¶é²æ§åˆ¶**ï¼šå¹³å‡å»¶é² â‰¤ 10Î¼s  
- **å¤šç”¨æˆ¶å…¬å¹³æ€§**ï¼šå„ç”¨æˆ¶ç²å¾—å…¬å¹³è³‡æºåˆ†é…
- **è³‡æºåˆ©ç”¨ç‡**ï¼šæœ‰æ•ˆåˆ©ç”¨è¨­å‚™å®¹é‡

---

## ğŸ“ˆ ç•¶å‰å¯¦ç¾ç‹€æ…‹

| åŠŸèƒ½æ¨¡çµ„ | å¯¦ç¾ç‹€æ…‹ | é©—è­‰ç‹€æ…‹ | å‚™è¨» |
|---------|---------|---------|------|
| **æ ¸å¿ƒèª¿åº¦å™¨** | âœ… å®Œæˆ | âœ… é€šé | æ”¯æ´ User ID å€åˆ† |
| **VIOPS æ­£è¦åŒ–** | âœ… å®Œæˆ | âœ… é€šé | è€ƒæ…® I/O ç‰¹å¾µ |
| **å‹•æ…‹èª¿æ•´** | âœ… å®Œæˆ | âœ… é€šé | åŸºæ–¼å»¶é²å›é¥‹ |
| **å¤šç§Ÿæˆ¶éš”é›¢** | âœ… å®Œæˆ | âœ… é€šé | LC/BE å„ªå…ˆç´š |
| **FIO æ•´åˆ** | âœ… å®Œæˆ | âœ… é€šé | æ¨™æº–å·¥å…·æ”¯æ´ |
| **è‡ªå‹•åŒ–æ¸¬è©¦** | âœ… å®Œæˆ | âœ… é€šé | å®Œæ•´æ¸¬è©¦æµç¨‹ |

---

## ğŸ¯ è«–æ–‡åŸºæº–ç·šå°±ç·’

ZQoS I/O èª¿åº¦å™¨å·²å®Œå…¨å¯¦ç¾ä¸¦é©—è­‰ï¼Œå…·å‚™ï¼š

1. **å®Œæ•´çš„è«–æ–‡ç®—æ³•å¯¦ç¾**ï¼šVIOPS æ­£è¦åŒ–ã€å‹•æ…‹èª¿æ•´ã€å¤šç§Ÿæˆ¶éš”é›¢
2. **å¥å…¨çš„æ¸¬è©¦æ¡†æ¶**ï¼šå¾åŸºç¤åŠŸèƒ½åˆ°æ€§èƒ½åŸºæº–çš„å®Œæ•´æ¸¬è©¦
3. **æ¨™æº–å·¥å…·æ•´åˆ**ï¼šæ”¯æ´ FIO ç­‰æ¥­ç•Œæ¨™æº–æ¸¬è©¦å·¥å…·
4. **å¯é‡ç¾çš„åŸºæº–**ï¼šè‡ªå‹•åŒ–æ¸¬è©¦è…³æœ¬ç¢ºä¿çµæœä¸€è‡´æ€§

**ç³»çµ±å·²æº–å‚™å¥½ä½œç‚ºè«–æ–‡ç ”ç©¶çš„åŸºç·š/å°ç…§çµ„ä½¿ç”¨**ã€‚